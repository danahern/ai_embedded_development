name: Hardware-in-the-Loop Tests

on:
  push:
    branches: [main]
    paths: ['firmware/**']
  workflow_dispatch:

concurrency:
  group: hw-test
  cancel-in-progress: true

jobs:
  nrf-test:
    runs-on: [self-hosted, hw-test]
    timeout-minutes: 15

    env:
      BOARD: nrf5340dk/nrf5340/cpuapp
      BOARD_SANITIZED: nrf5340dk_nrf5340_cpuapp
      CHIP: nRF5340_xxAA

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Checkout firmware submodule
        run: git submodule update --init firmware

      - name: Migrate CI workspace (one-time)
        run: |
          CI_WORKSPACE="$HOME/ci-workspace"
          if [ -d "${CI_WORKSPACE}/zephyr-apps" ] && [ ! -d "${CI_WORKSPACE}/firmware" ]; then
            echo "Migrating ci-workspace: zephyr-apps → firmware"
            mv "${CI_WORKSPACE}/zephyr-apps" "${CI_WORKSPACE}/firmware"
            # Re-init west to pick up new manifest path
            rm -rf "${CI_WORKSPACE}/.west"
          fi

      - name: Validate probe
        run: |
          echo "--- Detected probes ---"
          probe-rs list
          probe-rs list 2>&1 | grep -qi "j-link" || {
            echo "::error::No J-Link probe detected. Ensure usbipd has attached the device."
            exit 1
          }

          # Verify USB permissions by trying to read chip info
          if ! probe-rs chip info $CHIP > /dev/null 2>&1; then
            if probe-rs reset --chip $CHIP 2>&1 | grep -q "errno 13"; then
              echo "::error::USB permission denied. Install udev rules: curl -fsSL https://probe.rs/files/69-probe-rs.rules | sudo tee /etc/udev/rules.d/69-probe-rs.rules && sudo udevadm control --reload && sudo udevadm trigger"
              exit 1
            fi
          fi

      - name: Validate Zephyr SDK
        run: |
          test -n "${ZEPHYR_SDK_INSTALL_DIR:-}" || { echo "::error::ZEPHYR_SDK_INSTALL_DIR not set"; exit 1; }
          test -d "$ZEPHYR_SDK_INSTALL_DIR" || { echo "::error::Zephyr SDK not found at $ZEPHYR_SDK_INSTALL_DIR"; exit 1; }
          echo "Zephyr SDK $(cat "$ZEPHYR_SDK_INSTALL_DIR/sdk_version")"

      - name: Setup west environment
        run: |
          VENV="$HOME/ci-workspace/.venv"
          if [ ! -d "$VENV" ]; then
            mkdir -p "$HOME/ci-workspace"
            python3 -m venv "$VENV"
            "$VENV/bin/pip" install west
          fi
          echo "$VENV/bin" >> "$GITHUB_PATH"

      - name: Sync west workspace
        run: |
          CI_WORKSPACE="$HOME/ci-workspace"
          MANIFEST_HASH=$(sha256sum firmware/west.yml | cut -d' ' -f1)
          HASH_FILE="${CI_WORKSPACE}/.west_yml_hash"

          if [ ! -d "${CI_WORKSPACE}/.west" ]; then
            echo "::group::Bootstrap west workspace"
            mkdir -p "${CI_WORKSPACE}"
            rsync -a --delete "$GITHUB_WORKSPACE/firmware/" "${CI_WORKSPACE}/firmware/"
            cd "${CI_WORKSPACE}"
            west init -l firmware
            west update
            pip install -r zephyr/scripts/requirements.txt 2>/dev/null || true
            echo "$MANIFEST_HASH" > "$HASH_FILE"
            echo "::endgroup::"
          else
            rsync -a --delete "$GITHUB_WORKSPACE/firmware/" "${CI_WORKSPACE}/firmware/"

            if [ -f "$HASH_FILE" ] && [ "$(cat "$HASH_FILE")" = "$MANIFEST_HASH" ]; then
              echo "west.yml unchanged — skipping west update"
            else
              echo "::group::west update (manifest changed)"
              cd "${CI_WORKSPACE}"
              west update
              echo "$MANIFEST_HASH" > "$HASH_FILE"
              echo "::endgroup::"
            fi
          fi

      - name: Build hello_world
        run: |
          cd "$HOME/ci-workspace"
          west build -b $BOARD firmware/apps/hello_world \
            -d firmware/apps/hello_world/build/$BOARD_SANITIZED \
            --pristine=always

      - name: Build osal_demo
        run: |
          cd "$HOME/ci-workspace"
          west build -b $BOARD firmware/apps/osal_demo \
            -d firmware/apps/osal_demo/build/$BOARD_SANITIZED \
            --pristine=always

      - name: Recover board
        run: |
          echo "Erasing chip to clear APPROTECT lock..."
          probe-rs erase --chip $CHIP --allow-erase-all || \
            echo "::warning::Board erase failed — download will retry with --allow-erase-all"

      - name: Flash and validate hello_world
        run: |
          CI_WORKSPACE="$HOME/ci-workspace"
          BUILD="${CI_WORKSPACE}/firmware/apps/hello_world/build/${BOARD_SANITIZED}"
          ELF="${BUILD}/zephyr/zephyr.elf"
          LOG_DIR="${GITHUB_WORKSPACE}/rtt-logs"
          mkdir -p "$LOG_DIR"

          echo "--- Flash + run hello_world (10s timeout) ---"
          timeout 10 probe-rs run --chip $CHIP --allow-erase-all "$ELF" \
            > "$LOG_DIR/hello_world.log" 2>&1 || true

          echo "--- RTT output ---"
          cat "$LOG_DIR/hello_world.log"

          echo "--- Checking for success pattern ---"
          grep -q "hello_world booted" "$LOG_DIR/hello_world.log" || {
            echo "::error::hello_world boot validation failed — pattern 'hello_world booted' not found in RTT output"
            exit 1
          }
          echo "hello_world: PASS"

      - name: Flash and validate osal_demo
        run: |
          CI_WORKSPACE="$HOME/ci-workspace"
          BUILD="${CI_WORKSPACE}/firmware/apps/osal_demo/build/${BOARD_SANITIZED}"
          ELF="${BUILD}/zephyr/zephyr.elf"
          LOG_DIR="${GITHUB_WORKSPACE}/rtt-logs"

          echo "--- Flash + run osal_demo (20s timeout) ---"
          timeout 20 probe-rs run --chip $CHIP --allow-erase-all "$ELF" \
            > "$LOG_DIR/osal_demo.log" 2>&1 || true

          echo "--- RTT output ---"
          cat "$LOG_DIR/osal_demo.log"

          echo "--- Checking for success pattern ---"
          grep -q "ALL OSAL PRIMITIVES OK" "$LOG_DIR/osal_demo.log" || {
            echo "::error::osal_demo validation failed — pattern 'ALL OSAL PRIMITIVES OK' not found in RTT output"
            exit 1
          }
          echo "osal_demo: PASS"

      - name: Upload RTT logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rtt-logs
          path: rtt-logs/
          retention-days: 7

  esp32-test:
    runs-on: [self-hosted, hw-test]
    timeout-minutes: 15

    env:
      SERIAL_PORT: /dev/ttyUSB0

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Checkout firmware submodule
        run: git submodule update --init firmware

      - name: Validate ESP-IDF
        run: |
          test -n "${IDF_PATH:-}" || { echo "::error::IDF_PATH not set in runner .env"; exit 1; }
          test -d "$IDF_PATH" || { echo "::error::ESP-IDF not found at $IDF_PATH"; exit 1; }
          source "$IDF_PATH/export.sh"
          echo "ESP-IDF $(idf.py --version)"

      - name: Validate serial device
        run: |
          test -e "$SERIAL_PORT" || {
            echo "::error::Serial device $SERIAL_PORT not found. Ensure usbipd has attached the CP2102."
            echo "Available serial devices:"
            ls /dev/ttyUSB* /dev/ttyACM* 2>/dev/null || echo "(none)"
            exit 1
          }
          echo "Serial device: $SERIAL_PORT"
          # Verify permissions
          test -r "$SERIAL_PORT" && test -w "$SERIAL_PORT" || {
            echo "::error::No read/write access to $SERIAL_PORT. Add user to dialout group: sudo usermod -aG dialout $(whoami)"
            exit 1
          }

      - name: Build osal_tests
        run: |
          source "$IDF_PATH/export.sh"
          cd "$GITHUB_WORKSPACE/firmware/esp-idf/osal_tests"
          idf.py set-target esp32
          idf.py build

      - name: Flash osal_tests
        run: |
          source "$IDF_PATH/export.sh"
          cd "$GITHUB_WORKSPACE/firmware/esp-idf/osal_tests"
          idf.py -p "$SERIAL_PORT" flash

      - name: Capture serial output and validate
        run: |
          LOG_DIR="${GITHUB_WORKSPACE}/serial-logs"
          mkdir -p "$LOG_DIR"
          LOG_FILE="$LOG_DIR/osal_tests.log"

          # Capture serial output with pyserial — exits early on Unity summary
          timeout 30 python3 -u << 'PYEOF' "$SERIAL_PORT" "$LOG_FILE" || true
          import serial, sys, time

          port = sys.argv[1]
          log_path = sys.argv[2]

          ser = serial.Serial(port, 115200, timeout=1)
          # Toggle DTR/RTS to reset ESP32 and capture from boot
          ser.dtr = False
          ser.rts = True
          time.sleep(0.1)
          ser.rts = False
          time.sleep(0.1)

          with open(log_path, "w") as log:
              deadline = time.time() + 25
              while time.time() < deadline:
                  line = ser.readline()
                  if not line:
                      continue
                  try:
                      text = line.decode("utf-8", errors="replace").rstrip()
                  except Exception:
                      continue
                  print(text)
                  log.write(text + "\n")
                  log.flush()
                  # Unity summary looks like: "44 Tests 0 Failures 0 Ignored"
                  if "Failures" in text and "Tests" in text:
                      print(f"\n--- Unity summary detected, stopping capture ---")
                      break
          ser.close()
          PYEOF

          echo ""
          echo "--- Serial output ---"
          cat "$LOG_FILE"

          echo ""
          echo "--- Checking for success pattern ---"
          grep -q "0 Failures" "$LOG_FILE" || {
            echo "::error::osal_tests failed — '0 Failures' not found in serial output"
            # Show the summary line if present
            grep "Failures" "$LOG_FILE" || true
            exit 1
          }
          echo "osal_tests: PASS"

      - name: Upload serial logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: serial-logs
          path: serial-logs/
          retention-days: 7
