---
paths: ["**/*shell*", "**/build_tools.rs", "**/claude-mcps/**/*.py", "**/claude-mcps/**/*.rs", "**/esp-idf/**/main.c", "**/esp-idf/*_tests/**", "**/hw_test_runner/**", "**/hw_test_runner/ble.py", "**/hw_test_runner/provisioning.py", "**/prj.conf", "**/testcase.yaml", "**/tests/**", "**/tests/**/prj.conf", "**/tests/native/*.c", "**/tests/prj.conf", "**/tests/src/main.c"]
---
# Testing Learnings

- **MCP servers must have unit tests for core logic** — The workspace CLAUDE.md testing section says "Generated code must be unit tested" but this was interpreted as only applying to Zephyr apps/libraries, not MCP servers. This led to the knowledge-server shipping a bug in `next_sequence()` where the ID prefix format didn't match `generate_id()` output, causing every `capture()` call on the same day to overwrite the previous item.
- **native_sim is Linux-only** — The POSIX architecture (`native_sim`, `native_posix`) doesn't work on macOS. Use `qemu_cortex_m3` for unit tests that need an ARM target.
- **qemu_cortex_m3 (lm3s6965) has no flash driver — use mps2/an385 for NVS/Settings tests** — The qemu_cortex_m3 board uses the TI Stellaris lm3s6965 chip which has NO flash driver in the Zephyr tree. This means NVS, Settings with NVS backend, and any flash-dependent subsystem cannot work on this platform.
- **CoreBluetooth GATT cache causes BLE reconnection failures on macOS** — macOS CoreBluetooth aggressively caches GATT service discovery results. After a BLE disconnection (especially during factory reset or rapid reconnect cycles), reconnecting fails with `BleakError: disconnected` during `discover_services`.
- **mps2/an385 NVS sectors are 1KB — limit test blob sizes to ~900 bytes** — The mps2/an385 board's flash has 1024-byte sectors. NVS entries have overhead (header + key name), so the maximum storable value is approximately 1024 minus ~16 bytes header minus key length.
- **WiFi-only Zephyr builds need CONFIG_TEST_RANDOM_GENERATOR for entropy** — When building a WiFi-only test (no BT enabled) on nrf7002dk, the networking stack requires entropy (`z_impl_sys_rand_get`), but the nRF entropy driver doesn't get compiled without BT pulling it in. The linker fails with undefined reference to `z_impl_sys_rand_get`.
- **run_tests picks up NCS Zephyr instead of workspace Zephyr** — The `zephyr-build.run_tests()` MCP tool (twister) can pick up the NCS Zephyr installation (`/opt/nordic/ncs/v3.2.1/zephyr`) instead of the workspace-local Zephyr (`./zephyr`), causing CMake errors like `include could not find requested file: zephyr_default`. The `build()` tool finds the correct Zephyr via west's manifest.
- **Twister: integration_platforms doesn't exclude platforms — use platform_allow** — `integration_platforms` in testcase.yaml only controls which platforms are selected for integration testing (CI subset). It does NOT prevent twister from running the test on other platforms when `-p <platform>` is passed.
- **hw-test-runner MCP decouples BLE testing from probe-rs** — The hw-test-runner Python MCP server provides BLE and TCP testing that runs independently of probe-rs. BLE uses bleak (CoreBluetooth on macOS), so there's no J-Link conflict. This eliminates the disconnect/reconnect cycle when alternating between RTT debugging and BLE testing. Key tools: ble_discover, ble_read, ble_write, ble_subscribe, wifi_provision, wifi_scan_aps, wifi_status, wifi_factory_reset, tcp_throughput. Registered in .mcp.json with its own .venv.
- **Twister pyenv fix now in zephyr-build MCP** — The zephyr-build MCP now strips `~/.pyenv/shims` from PATH before spawning twister. This fixes the JSON parsing failure caused by pyenv's python shim emitting error text to stderr (which cmake merges into stdout via stderr=subprocess.STDOUT). No manual PATH workaround needed anymore — `run_tests()` handles it automatically.
- **shell_execute_cmd returns 1 when help is printed** — When a shell command has a NULL handler (parent with subcommands only), the shell prints subcommand help and returns `SHELL_CMD_HELP_PRINTED` (1), not 0. Tests must call the full subcommand path (e.g., `"board info"` not `"board"`).
- **Shell dummy backend for testing** — `CONFIG_SHELL_BACKEND_DUMMY=y` works well for testing shell commands without hardware. Pattern:
- **Unity test framework requires setUp/tearDown stubs** — When using vendored Unity (ThrowTheSwitch) for native C tests, the linker will fail with undefined symbols `_setUp` and `_tearDown` if you don't define them. Unity's `UnityDefaultTestRun` calls both before/after each test.
- **ESP-IDF Unity test project pattern for shared library code** — To unit test shared library code (`lib/`) on ESP-IDF, create a standalone ESP-IDF project (not embedded in the app). Pattern:
