---
paths: ["**/*provision_tool*.py", "**/.github/workflows/*.yml", "**/ble/*.py", "**/build_tools.rs", "**/freertos/thread.c", "**/freertos/workqueue.c", "**/posix/*.c", "**/posix/*.h", "**/pyproject.toml", "**/types.rs"]
---
# Toolchain Learnings

- **ESP32 FreeRTOS StackType_t is uint8_t — stack sizes in bytes not words** — On Xtensa ESP32, `StackType_t` is `uint8_t` (not `uint32_t` like ARM Cortex-M). This means `xTaskCreate()` stack_depth parameter is in BYTES, not words. A value of 2048 gives only 2KB of stack, not 8KB.
- **Per-board build directories in zephyr-build MCP** — Build directories changed from `apps/<name>/build/` to `apps/<name>/build/<board_sanitized>/` where `/` in board names becomes `_` (e.g., `nrf7002dk/nrf5340/cpuapp` → `nrf7002dk_nrf5340_cpuapp`). This prevents building for one board from wiping another board's artifacts. `clean(app)` removes all board builds; `clean(app, board)` removes just one. `list_apps()` now returns `built_boards` array instead of single `board` field.
- **bleak macOS: BLEDevice UUID expires between scans — use find_device helper** — On macOS, CoreBluetooth assigns UUIDs that can expire between BLE scan sessions. Passing a stale UUID string to `BleakClient(address)` raises `BleakDeviceNotFoundError`. Fix: always do a fresh `BleakScanner.discover()` and pass the `BLEDevice` object to `BleakClient(device)`. Use `return_adv=True` for advertisement data (RSSI). The `BLEDevice.rssi` attribute was removed in newer bleak versions.
- **macOS POSIX gaps: 3 missing APIs require workarounds** — macOS is POSIX-compliant but lacks three commonly-assumed APIs:
- **espressif/idf Docker container needs manual export.sh in GitHub Actions** — The `espressif/idf:v5.5.2` Docker image sets `IDF_PATH` but relies on its entrypoint to source `export.sh` and add `idf.py` to PATH. GitHub Actions overrides the container entrypoint when using `container:`, so `idf.py` is not found (exit code 127).
- **Python MCP pyproject.toml must use setuptools.build_meta** — When creating Python MCP servers with setuptools, the build-backend must be `setuptools.build_meta`, not `setuptools.backends._legacy:_Backend`. The legacy backend causes installation failures. Follow the saleae-logic pattern: `[build-system]\nrequires = ["setuptools>=68.0"]\nbuild-backend = "setuptools.build_meta"`. Add dev dependencies in `[project.optional-dependencies]` for pytest.
