---
paths: ["**/*.cmake", "**/*.conf", "**/*.dts", "**/*.dtsi", "**/*.overlay", "**/.gitignore", "**/CMakeLists.txt", "**/Kconfig*", "**/lib/*/CMakeLists.txt", "**/module.yml", "**/testcase.yaml", "**/tests/**", "**/tests/CMakeLists.txt", "**/zephyr/module.yml"]
---
# Build System Learnings

- **Twister needs Zephyr SDK env vars in MCP subprocesses** — MCP server subprocesses don't inherit shell profile env vars. Twister requires `ZEPHYR_TOOLCHAIN_VARIANT` and `ZEPHYR_SDK_INSTALL_DIR` to be set. The `zephyr-build` MCP auto-detects the SDK from `~/.cmake/packages/Zephyr-sdk/` (registered by `setup.sh`). If auto-detection fails, set these env vars in the MCP server's launch environment.
- **Gitignore negation requires wildcard, not directory slash** — Git's `.gitignore` negation (`!path`) doesn't work when the parent is ignored with a trailing slash (e.g., `.claude/`). The slash makes git skip the entire directory without checking children. Use a wildcard instead: `.claude/*` with `!.claude/rules/` to ignore everything in `.claude/` except `rules/`.
- **Don't duplicate board overlays — use library's boards/ directory** — When a library (e.g. crash_log) provides board-specific DTS overlays in its `boards/` directory, apps should NOT copy those overlays into their own `boards/` directory. Zephyr auto-discovers overlays from the app's `boards/` dir, but the library's overlays are included via `DTC_OVERLAY_FILE` in CMakeLists.txt. Duplicating them causes maintenance drift and confusion about which is authoritative.
- **Workspace module.yml auto-discovers all lib/ subdirectories — don't use ZEPHYR_EXTRA_MODULES in tests** — The workspace-level `zephyr-apps/zephyr/module.yml` has `cmake: lib` which processes `lib/CMakeLists.txt`. Any `add_subdirectory()` calls there register libraries as part of the workspace module.
- **module.yml paths are relative to module root, not the yml file** — `zephyr/module.yml` paths (`cmake:`, `kconfig:`) resolve relative to the module root (the parent of `zephyr/`), not relative to `module.yml` itself. Use `cmake: .` and `kconfig: Kconfig`, not `cmake: ..` / `kconfig: ../Kconfig`.
- **OVERLAY_CONFIG vs DTC_OVERLAY_FILE** — `OVERLAY_CONFIG` is for Kconfig fragments (`.conf` files). `DTC_OVERLAY_FILE` is for devicetree overlays (`.overlay` files). Zephyr auto-discovers DTS overlays from `boards/` but you must explicitly list Kconfig overlays via `OVERLAY_CONFIG`.
- **Board qualifiers use / in CMake, _ in filenames** — `${BOARD}` expands to `nrf52840dk/nrf52840` (with `/`) but DTS overlay files use `_` separator: `nrf52840dk_nrf52840.overlay`. Don't set `DTC_OVERLAY_FILE` manually — put overlays in the app's `boards/` directory and let Zephyr auto-discover them.
- **Use zephyr/module.yml for shared library auto-discovery** — Instead of setting `ZEPHYR_EXTRA_MODULES` in every app's CMakeLists.txt, place a `zephyr/module.yml` at the repo root pointing to a top-level `lib/CMakeLists.txt` and `lib/Kconfig`. Apps just enable `CONFIG_<LIB>=y` in prj.conf. This eliminates boilerplate and ensures new apps get all libraries automatically.
- **size_report 'all' target produces one file, not two** — Passing `all` as a positional arg to Zephyr's `size_report` script generates a single `all.json` combining ROM and RAM. To get separate `rom.json` and `ram.json`, pass `rom ram` as two separate positional args. The JSON output path uses `{target}` replacement — `all` replaces to `all`, not to separate files.
