id: k-2026-0216-028
title: ESP-IDF Unity test project pattern for shared library code
body: |-
  To unit test shared library code (`lib/`) on ESP-IDF, create a standalone ESP-IDF project (not embedded in the app). Pattern:

  ```
  esp-idf/<test_project>/
    CMakeLists.txt                    # EXTRA_COMPONENT_DIRS + project()
    sdkconfig.defaults                # CONFIG_UNITY_ENABLE_FLOAT=y, CONFIG_FREERTOS_HZ=1000
    main/
      CMakeLists.txt                  # REQUIRES unity, <components>
      main.c                          # setUp/tearDown stubs, test functions, app_main() with UNITY_BEGIN/RUN_TEST/UNITY_END
    components/
      <lib_wrapper>/CMakeLists.txt    # idf_component_register() with SRCS from ../../../../lib/<name>/src/
  ```

  Key details:
  - Components reference shared lib sources via relative paths (no duplication)
  - Zephyr shim headers (LOG_* → ESP_LOG*, errno.h, stdint.h) go in `shim/zephyr/` as PRIV_INCLUDE_DIRS
  - Unity requires `void setUp(void) {}` and `void tearDown(void) {}` even if empty
  - Per-test setup (like Zephyr fixtures) must be called manually before each test — Unity's setUp/tearDown is global
  - `RUN_TEST()` in `app_main()` drives execution; no auto-discovery like ztest
  - Flash and read serial to see results: `idf.py -p PORT flash` then read serial with pyserial (idf.py monitor needs TTY)
category: pattern
severity: informational
applies_to:
  boards: []
  chips: []
  tools:
  - esp-idf
  - unity
  subsystems:
  - testing
file_patterns:
- '**/esp-idf/**/main.c'
- '**/esp-idf/*_tests/**'
status: unvalidated
validated_by: []
deprecated: false
superseded_by: null
created: 2026-02-16
updated: 2026-02-16
author: claude
source_session: null
tags:
- esp-idf
- unity
- testing
- shared-library
- component
