id: k-3dbe9443-081f-44b1-8a33-3d6f53bdc9be
title: run_tests picks up NCS Zephyr instead of workspace Zephyr
body: |-
  The `zephyr-build.run_tests()` MCP tool (twister) can pick up the NCS Zephyr installation (`/opt/nordic/ncs/v3.2.1/zephyr`) instead of the workspace-local Zephyr (`./zephyr`), causing CMake errors like `include could not find requested file: zephyr_default`. The `build()` tool finds the correct Zephyr via west's manifest.

  Workaround: Build with `zephyr-build.build()` first (which resolves correctly), then run the QEMU binary directly:
  ```bash
  qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -vga none -net none \
    -chardev stdio,id=con,mux=on -serial chardev:con -mon chardev=con,mode=readline \
    -kernel <build_dir>/zephyr/zephyr.elf -serial none
  ```

  Or use Docker-based twister (`make test`) which has a clean environment.
category: toolchain
severity: important
applies_to:
  boards: []
  chips: []
  tools:
  - twister
  - zephyr-build
  subsystems:
  - testing
  - build-system
file_patterns:
- '**/testcase.yaml'
- '**/tests/**/prj.conf'
status: unvalidated
validated_by: []
deprecated: false
superseded_by: null
created: 2026-02-17
updated: 2026-02-17
author: claude
source_session: null
tags:
- twister
- qemu
- ncs
- testing
- workaround
