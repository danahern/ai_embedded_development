id: k-2026-0216-027
title: CoreBluetooth GATT cache causes BLE reconnection failures on macOS
body: |-
  macOS CoreBluetooth aggressively caches GATT service discovery results. After a BLE disconnection (especially during factory reset or rapid reconnect cycles), reconnecting fails with `BleakError: disconnected` during `discover_services`.

  Workaround: Reset the ESP32 (hardware reset via serial DTR/RTS toggle) before attempting reconnection. This gives CoreBluetooth time to invalidate its cache. A 5+ second delay between disconnect and reconnect also helps.

  This is a client-side (macOS) issue, not a firmware bug. The device is advertising correctly and GATT services are properly registered. Affects bleak-based tools and hw-test-runner MCP.

  For integration tests, use a single persistent BLE connection rather than connect/disconnect/reconnect patterns.
category: operational
severity: important
applies_to:
  boards: []
  chips: []
  tools:
  - bleak
  - hw-test-runner
  subsystems:
  - ble
file_patterns:
- '**/hw_test_runner/ble.py'
- '**/hw_test_runner/provisioning.py'
status: unvalidated
validated_by: []
deprecated: false
superseded_by: null
created: 2026-02-16
updated: 2026-02-16
author: claude
source_session: null
tags:
- ble
- macos
- corebluetooth
- gatt-cache
- bleak
