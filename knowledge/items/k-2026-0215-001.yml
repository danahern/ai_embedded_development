id: k-2026-0215-001
title: Workspace module.yml auto-discovers all lib/ subdirectories â€” don't use ZEPHYR_EXTRA_MODULES in tests
body: |-
  The workspace-level `zephyr-apps/zephyr/module.yml` has `cmake: lib` which processes `lib/CMakeLists.txt`. Any `add_subdirectory()` calls there register libraries as part of the workspace module.

  If a library test also sets `ZEPHYR_EXTRA_MODULES` to its parent dir (like crash_log's test does), the library gets added twice: once via the workspace module, once via ZEPHYR_EXTRA_MODULES. When building with `-d tests/build/` (build dir inside the module source tree), this causes a CMake binary directory conflict: "The binary directory ... is already used to build a source directory."

  **Fix**: Don't use ZEPHYR_EXTRA_MODULES in test CMakeLists.txt for workspace libraries. The library is already auto-discovered. Just enable the Kconfig option in prj.conf.

  Also: use `zephyr_include_directories_ifdef()` (global) instead of `zephyr_library_include_directories_ifdef()` (private) for public API headers that consumer apps need to find.
category: toolchain
severity: important
applies_to:
  boards: []
  chips: []
  tools: []
  subsystems:
  - build-system
  - zephyr-module
file_patterns:
- '**/zephyr/module.yml'
- '**/tests/CMakeLists.txt'
- '**/lib/*/CMakeLists.txt'
status: unvalidated
validated_by: []
deprecated: false
superseded_by: null
created: 2026-02-15
updated: 2026-02-15
author: claude
source_session: null
tags:
- zephyr
- cmake
- modules
- build
