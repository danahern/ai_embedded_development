id: k-2026-0215-001
title: OSAL work queues must be static â€” thread outlives stack frame
body: |-
  `eai_osal_workqueue_create()` (and Zephyr's `k_work_queue_start()`) spawns a persistent thread. If the `eai_osal_workqueue_t` is stack-allocated in a function, the thread continues running after the function returns, referencing freed stack memory. This causes hard faults (typically "ESF could not be retrieved" / fault during interrupt handling).

  **Fix:** Always declare work queues as `static` or at file scope. The thread stack (`EAI_OSAL_THREAD_STACK_DEFINE`) must also be file-scope (it already is, since it's a macro expanding to a global).

  In tests, use a shared static work queue initialized once with a guard flag, rather than creating a new one per test function.
category: pattern
severity: important
applies_to:
  boards: []
  chips: []
  tools: []
  subsystems:
  - eai_osal
  - workqueue
file_patterns:
- '**/eai_osal/**'
- '**/workqueue*'
status: unvalidated
validated_by: []
deprecated: false
superseded_by: null
created: 2026-02-15
updated: 2026-02-15
author: claude
source_session: null
tags:
- work-queue
- lifetime
- static-allocation
- hard-fault
