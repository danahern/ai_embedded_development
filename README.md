# Embedded Development Workspace

AI-assisted embedded development with Claude Code. Four custom MCP servers expose 61 hardware tools — build systems, debug probes, flash programmers, and logic analyzers — so Claude can orchestrate the full firmware workflow from a single conversation.

See [PRD.md](PRD.md) for architecture, design decisions, and detailed tool specifications.

## Quick Start

```bash
# Clone with submodules
git clone --recursive <repo-url>
cd embedded-workspace

# Run setup (builds MCP servers, installs dependencies, generates .mcp.json)
./setup.sh
```

## Setup Options

```bash
./setup.sh                              # Install everything (default)
./setup.sh --no-zephyr                  # Skip Zephyr RTOS setup
./setup.sh --no-esp-idf                 # Skip ESP-IDF setup
./setup.sh --no-saleae                  # Skip Saleae Logic setup
./setup.sh --skip-tests                 # Skip test verification
./setup.sh --no-zephyr --no-esp-idf     # Only embedded-probe + saleae-logic
```

The script is idempotent — safe to re-run at any time. It never auto-installs system packages; missing prerequisites are reported with install commands.

## MCP Servers

| Server | Tools | Language | Purpose |
|--------|-------|----------|---------|
| [embedded-probe](claude-mcps/embedded-probe/PRD.md) | 27 | Rust | Debug probes, flash, memory, RTT, breakpoints |
| [saleae-logic](claude-mcps/saleae-logic/PRD.md) | 21 | Python | Signal capture, protocol decode, statistical analysis |
| [esp-idf-build](claude-mcps/esp-idf-build/PRD.md) | 8 | Rust | ESP32 build, flash, serial monitor |
| [zephyr-build](claude-mcps/zephyr-build/PRD.md) | 5 | Rust | Zephyr RTOS build system |
| **Total** | **61** | | |

All servers communicate with Claude Code over stdio (JSON-RPC). Registration is automatic via `.mcp.json`, which `setup.sh` generates with absolute paths.

## Prerequisites

| Tool | Required For | Install |
|------|-------------|---------|
| git | Everything | Xcode CLI tools |
| python3 >= 3.10 | Saleae Logic, Zephyr tooling | `brew install python@3.12` |
| Rust (cargo) | embedded-probe, zephyr-build, esp-idf-build | `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \| sh` |
| libusb | embedded-probe (macOS) | `brew install libusb` |
| Zephyr SDK | Zephyr compilation | [Getting Started Guide](https://docs.zephyrproject.org/latest/develop/getting_started/index.html) |
| ESP-IDF v5+ | ESP32 builds | [ESP-IDF Setup](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/) |
| Saleae Logic 2 | Signal analysis | [Saleae Download](https://www.saleae.com/downloads/) (enable scripting API in Preferences) |
| Debug probe | Flashing/debugging | J-Link, ST-Link, DAPLink, or CMSIS-DAP |

## Workspace Structure

```
embedded-workspace/
├── .mcp.json                  # MCP server registration (generated by setup.sh)
├── CLAUDE.md                  # Workspace conventions and workflows
├── PRD.md                     # Architecture and design documentation
├── setup.sh                   # Automated setup script
│
├── claude-config/             # Claude Code skills and configuration (submodule)
├── claude-mcps/               # MCP servers (submodule)
│   ├── embedded-probe/        #   Rust — 27 debug/flash tools
│   ├── zephyr-build/          #   Rust — 5 build tools
│   ├── esp-idf-build/         #   Rust — 8 build/flash/monitor tools
│   └── saleae-logic/          #   Python — 21 analysis tools
│
├── zephyr-apps/               # Zephyr applications + west manifest (submodule)
│   └── apps/                  #   Application source code
├── esp-dev-kits/              # ESP-IDF example projects (cloned)
├── test-tools/                # Python testing utilities (submodule)
│
├── zephyr/                    # (west-managed, gitignored)
├── bootloader/                # (west-managed, gitignored)
├── modules/                   # (west-managed, gitignored)
└── tools/                     # (west-managed, gitignored)
```

## Usage with Claude Code

Open the workspace in Claude Code — MCP servers register automatically from `.mcp.json`. See [CLAUDE.md](CLAUDE.md) for full tool reference and typical workflows.

**Zephyr**: Build firmware, connect probe, flash + validate boot, monitor RTT output.

**ESP-IDF**: Set target chip, build, flash all segments, capture serial output.

**Signal Analysis**: Capture signals, decode protocols (I2C/SPI/UART/CAN), analyze timing and errors.

## Testing

All 74 tests run without hardware connected:

```bash
# Run all tests (done automatically by setup.sh unless --skip-tests)
cd claude-mcps/embedded-probe && cargo test       # 14 tests
cd claude-mcps/zephyr-build && cargo test          # 19 tests
cd claude-mcps/esp-idf-build && cargo test         # 16 tests
cd claude-mcps/saleae-logic && .venv/bin/pytest tests/test_analysis.py tests/test_server_startup.py  # 25 tests
```

## Troubleshooting

| Problem | Solution |
|---------|----------|
| `west: command not found` | Activate venv: `source zephyr-apps/.venv/bin/activate` |
| `cargo build` fails on macOS | Install libusb: `brew install libusb` |
| ESP-IDF not detected | Set `IDF_PATH` or install to `~/esp/esp-idf` |
| Logic 2 connection refused | Start Logic 2 app, enable scripting API in Preferences |
| Wrong paths in `.mcp.json` | Re-run `./setup.sh` (regenerates with current absolute paths) |
| Submodule directories empty | Run `git submodule update --init --recursive` |

## Documentation

- [PRD.md](PRD.md) — Architecture, design decisions, end-to-end workflows
- [CLAUDE.md](CLAUDE.md) — MCP tool reference and typical workflows for Claude Code
- [claude-mcps/embedded-probe/PRD.md](claude-mcps/embedded-probe/PRD.md) — Debug probe server
- [claude-mcps/saleae-logic/PRD.md](claude-mcps/saleae-logic/PRD.md) — Logic analyzer server
- [claude-mcps/esp-idf-build/PRD.md](claude-mcps/esp-idf-build/PRD.md) — ESP-IDF build server
- [claude-mcps/zephyr-build/PRD.md](claude-mcps/zephyr-build/PRD.md) — Zephyr build server
