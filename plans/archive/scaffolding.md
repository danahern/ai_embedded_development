# Project Scaffolding

Status: Complete
Created: 2026-02-14

## Problem

Creating a new Zephyr app is manual copy-paste. With 3 apps and more planned, we need consistent scaffolding.

## What Was Built

### 1. `create_app` MCP tool (zephyr-build)

Scaffolds a new app from a template with full overlay wiring.

**Args:** `name` (required), `template` (default "core"), `board`, `libraries`, `description`, `workspace_path`

**Behavior:**
- Validates name (lowercase alphanumeric + underscore)
- Checks app doesn't already exist
- Reads library manifests to generate correct `OVERLAY_CONFIG` lines in CMakeLists.txt
- Generates: `CMakeLists.txt`, `prj.conf`, `manifest.yml`, `src/main.c`
- Extra `libraries` beyond template defaults are supported

### 2. `list_templates` MCP tool (zephyr-build)

Returns available templates with descriptions, default libraries, and file lists. Claude calls this before `create_app` to present options.

### 3. App manifests (`apps/<name>/manifest.yml`)

Per-app metadata generated by `create_app`, read by `list_apps`.

```yaml
description: "One-line description"
boards:
  - nrf52840dk/nrf52840
libraries:
  - crash_log
  - device_shell
template: core
```

`list_apps` reads these and returns enriched `AppInfo` with `description`, `target_boards`, `libraries` fields. Backwards-compatible — apps without manifest.yml still work.

### 4. Library manifests (`lib/<name>/manifest.yml`)

Each library declares its default overlays so `create_app` can wire them automatically.

```yaml
name: crash_log
description: "Boot-time coredump detection and shell commands"
default_overlays:
  - conf/debug_base.conf
  - conf/debug_coredump_flash.conf
board_overlays: true
depends: []
```

### Template: `core`

One template that serves as the foundation. Includes shell + crash debug out of the box.

```
apps/<name>/
├── CMakeLists.txt    # OVERLAY_CONFIG for crash_log + device_shell
├── prj.conf          # Logging, stack sizes, reboot
├── manifest.yml      # Metadata: description, boards, libraries
└── src/main.c        # LOG_MODULE_REGISTER, boot message, idle loop
```

## Files Changed

| File | Change |
|------|--------|
| `claude-mcps/zephyr-build/Cargo.toml` | Added `serde_yaml` |
| `claude-mcps/zephyr-build/src/tools/templates.rs` | **New** — template constants + render function |
| `claude-mcps/zephyr-build/src/tools/types.rs` | Added `CreateAppArgs/Result`, `ListTemplatesArgs/Result`, `LibraryManifest`, `AppManifest`; enhanced `AppInfo` |
| `claude-mcps/zephyr-build/src/tools/build_tools.rs` | Added `create_app`, `list_templates` tools; enhanced `list_apps` |
| `claude-mcps/zephyr-build/src/tools/mod.rs` | Export `templates` module |
| `zephyr-apps/lib/crash_log/manifest.yml` | **New** — library manifest |
| `zephyr-apps/lib/device_shell/manifest.yml` | **New** — library manifest |

## Test Coverage

60 tests total, including:
- Template rendering (7 tests)
- `create_app`: basic creation, invalid name, already exists, unknown template, unknown library (5 tests)
- `list_templates`: returns core template with correct metadata (1 test)
- `list_apps` manifest enrichment: with manifest, without manifest for backwards compatibility (2 tests)

## What Was Deferred

- Additional templates (ble, sensor) — will add in Phase 6 when patterns emerge
- Transitive library dependencies — `depends` field exists in manifest but isn't resolved yet
- CI/build matrix integration from manifests
